<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lingo Dictionary — Duolingo-style</title>
<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --ink:#e2e8f0; --muted:#94a3b8;
    --card:#0b1325; --line:#1f2a44; --accent1:#22d3ee; --accent2:#34d399;
    --warn:#ef4444; --ok:#06d6a0; --gold:#facc15;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  button,input,select,label{pointer-events:auto}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .hero{background: linear-gradient(180deg,#132038 0%, #0f172a 100%);border:1px solid var(--line); border-radius:16px; padding:16px 16px 0; margin-bottom:12px;}
  .title{ margin:0; font-size:22px; font-weight:900; background:linear-gradient(90deg,var(--accent2),var(--accent1)); -webkit-background-clip:text; background-clip:text; color:transparent;}
  .tabs{ display:flex; gap:8px; margin:12px 0 0 }
  .tab{ flex:1; text-align:center; padding:10px; cursor:pointer; border:1px solid var(--line); color:var(--ink); background:var(--panel); border-radius:12px 12px 0 0; font-weight:700 }
  .tab.active{ background:linear-gradient(180deg,#152240,#0f172a); border-bottom-color:transparent }
  .panel{ border:1px solid var(--line); border-top:none; background:var(--panel); padding:16px; border-radius:0 12px 12px 12px;}
  .row{ display:flex; gap:10px; flex-wrap:wrap }
  input[type="text"], select{ background:var(--card); border:1px solid var(--line); color:var(--ink); border-radius:10px; padding:10px 12px; outline:none; width:100%;}
  .btn{ padding:10px 14px; border:none; border-radius:10px; background:#1e293b; color:var(--ink); cursor:pointer }
  .btn.primary{ background:linear-gradient(90deg,var(--accent2),var(--accent1)); color:#0b1020; font-weight:800 }
  .btn.ghost{ background:transparent; border:1px solid var(--line) }
  .pill{ padding:6px 10px; border:1px solid var(--line); background:var(--card); border-radius:999px; font-size:13px }
  .grid{ display:grid; gap:10px }
  .cards{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px }
  .muted{ color:var(--muted) }
  .badge{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px }
  .badge.ok{ background:rgba(6,214,160,.12); color:var(--ok) }
  .badge.warn{ background:rgba(239,68,68,.12); color:var(--warn) }
  .badge.gold{ background:rgba(250,204,21,.12); color:var(--gold) }
  .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; background:#111827; color:#e5e7eb; padding:10px 14px; border-radius:10px; border:1px solid #1f2937; box-shadow:0 10px 30px rgba(0,0,0,.35); z-index:20 }
  .flex{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  .spacer{ flex:1 }
  .hidden{ display:none !important }
  .center{ text-align:center }
  .big{ font-size:18px }
  @media (max-width:600px){ .title{font-size:20px} }
  .answerChoice{ width:100%; text-align:left; background:#0c1730; border:1px solid var(--line); color:var(--ink); padding:12px; border-radius:12px; cursor:pointer; }
  .answerChoice.correct{ outline:2px solid var(--ok) }
  .answerChoice.wrong{ outline:2px solid var(--warn) }
  .bank{ display:flex; gap:8px; flex-wrap:wrap; padding:8px; background:#0c1730; border:1px dashed var(--line); border-radius:12px }
  .chip{ padding:8px 10px; background:#0f1d36; border:1px solid var(--line); border-radius:999px; cursor:pointer }
  .chip.used{ opacity:.5; pointer-events:none }
  .kbd{ background:#111; border:1px solid #333; padding:2px 6px; border-radius:6px; color:#fff }
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:50 }
  .panel2{ background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:16px; width:min(560px, 94%); box-shadow:0 20px 60px rgba(0,0,0,.35) }
  .rowC{ display:flex; align-items:center; gap:10px; justify-content:center; flex-wrap:wrap }
  .mute{ margin-left:6px; }
</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <div class="flex">
      <h1 class="title">Lingo Dictionary — Duolingo-style</h1>
      <span id="streakBadge" class="badge gold" title="Streak">🔥 <span id="streak">0</span></span>
      <span id="xpBadge" class="badge ok" title="XP">⭐ <span id="xp">0</span></span>
      <span id="heartsBadge" class="badge warn" title="Hearts">❤ <span id="hearts">3</span></span>
      <div class="spacer"></div>
      <label class="pill">🔊 Sound <input id="muteToggle" class="mute" type="checkbox" /></label>
      <button id="helpBtn" class="btn ghost">Controls</button>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="learn">Learn</button>
      <button class="tab" data-tab="practice">Practice</button>
      <button class="tab" data-tab="dictionary">Dictionary</button>
    </div>
  </div>

  <!-- Learn -->
  <section id="learn" class="panel">
    <div class="grid" style="grid-template-columns:1.6fr .8fr .8fr">
      <div class="row">
        <input id="lookupInput" type="text" placeholder="Type a word (English or Esan) and press Enter…" />
      </div>
      <button id="lookupBtn" class="btn primary">Look up</button>
      <button id="viewBtn" class="btn">View all</button>
    </div>

    <div id="lookupResult" class="card" style="margin-top:12px; display:none"></div>
  </section>

  <!-- Practice -->
  <section id="practice" class="panel hidden">
    <div class="flex">
      <div class="pill">Category:
        <select id="catPracticeSel">
          <option value="all">All</option>
          <option value="numbers">Numbers</option>
          <option value="others">Others</option>
        </select>
      </div>
      <div class="pill">Mode:
        <select id="modeSel">
          <option value="mc">Multiple Choice</option>
          <option value="order">Word Bank (order)</option>
        </select>
      </div>
      <div class="pill">Direction:
        <select id="directionSel">
          <option value="en2esan">English → Esan</option>
          <option value="esan2en">Esan → English</option>
        </select>
      </div>
      <div class="spacer"></div>
      <button id="startPractice" class="btn primary">Start</button>
      <button id="skipBtn" class="btn">Skip</button>
    </div>

    <div id="progressNote" class="muted" style="margin-top:8px"></div>

    <div id="challengeArea" class="card" style="margin-top:12px; display:none">
      <div id="prompt" class="big" style="margin-bottom:10px;"></div>
      <div id="mcWrap" class="grid hidden" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))"></div>
      <div id="orderWrap" class="hidden">
        <div class="bank" id="bank"></div>
        <div style="margin-top:8px" class="bank" id="answerBank"></div>
        <div class="flex" style="margin-top:8px">
          <button id="clearOrder" class="btn">Clear</button>
          <button id="submitOrder" class="btn primary">Submit</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Dictionary -->
  <section id="dictionary" class="panel hidden">
    <div class="flex">
      <div class="pill">Filter:
        <select id="catFilter">
          <option value="all">All</option>
          <option value="numbers">Numbers</option>
          <option value="others">Others</option>
        </select>
      </div>
      <div class="spacer"></div>
      <button id="exportBtn" class="btn">Export JSON</button>
      <label class="btn ghost" for="importFile">Import JSON</label>
      <input id="importFile" type="file" accept=".json" style="display:none" />
      <button id="addBtn" class="btn primary">Add Word</button>
    </div>

    <div id="dictList" class="cards" style="margin-top:12px"></div>
  </section>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden" aria-live="polite"></div>

<!-- Help Modal -->
<div id="helpModal" class="toast hidden" style="top:16px; bottom:auto; max-width:720px; width:calc(100% - 32px)">
  <div class="big" style="margin-bottom:6px; font-weight:900">Controls</div>
  <div class="muted">
    • Navigate tabs at the top • <span class="kbd">Enter</span> on lookup •
    Practice: choose category, click answers or build with chips • <span class="kbd">S</span> skip • <span class="kbd">H</span> help • Toggle sound with checkbox
  </div>
</div>

<!-- Congrats Modal -->
<div id="doneModal" class="modal hidden">
  <div class="panel2 center">
    <div class="big" style="font-weight:900">🎉 Congrats!</div>
    <div class="muted" id="doneText" style="margin:8px 0 12px">You completed this category.</div>
    <div class="rowC">
      <button id="chooseAnother" class="btn">Choose Another Category</button>
      <button id="repeatSession" class="btn ghost">Repeat This Category</button>
      <button id="closeDone" class="btn primary">Close</button>
    </div>
  </div>
</div>

<script>
/* ---------- Tiny DOM helpers ---------- */
const $  = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

/* =============================
   0) Data (seed from your Kivy app)
   ============================= */
const SEED_NUMBERS = {
  "3n1 triplets": ["Akhinsin N"],
  "A Child Can’t Be Bought": ["Amiende"]
};
const SEED_OTHERS = {
  "Uwa": ["House","Building","Home"],
  "Elo": ["Eye","Sight"],
  "Aga": ["Chair","Seat"],
  "Obo": ["Hand","Palm"]
};

/* Storage Keys */
const LS_KEYS = { numbers: "lingo_numbers", others: "lingo_others", meta: "lingo_meta", mute: "lingo_mute" };

/* Load or seed */
const loadJson = (k)=>{ try{ return JSON.parse(localStorage.getItem(k)||"null"); }catch{ return null; } };
const saveJson = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
let words_numbers = loadJson(LS_KEYS.numbers) || SEED_NUMBERS;
let words_others  = loadJson(LS_KEYS.others)  || SEED_OTHERS;
let META = loadJson(LS_KEYS.meta) || { xp:0, hearts:3, streak:0 };
saveJson(LS_KEYS.numbers, words_numbers);
saveJson(LS_KEYS.others,  words_others);
saveJson(LS_KEYS.meta,    META);

/* =============================
   Sounds (Web Audio, lightweight)
   ============================= */
let AC, muted = localStorage.getItem(LS_KEYS.mute) === "1";
const muteToggle = $("#muteToggle");
muteToggle.checked = muted;
muteToggle.onchange = () => { muted = muteToggle.checked; localStorage.setItem(LS_KEYS.mute, muted ? "1" : "0"); };

function ensureAC(){ if (!AC) AC = new (window.AudioContext||window.webkitAudioContext)(); }
function beep(freq=880, dur=0.12, type='sine', gain=0.2){
  if (muted) return;
  ensureAC();
  const o = AC.createOscillator(), g = AC.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.value = 0; g.gain.setTargetAtTime(gain, AC.currentTime, 0.01);
  o.connect(g).connect(AC.destination);
  o.start();
  g.gain.setTargetAtTime(0, AC.currentTime + dur*0.8, 0.03);
  o.stop(AC.currentTime + dur);
}
function chord(freqs=[523,659,784], dur=0.35, type='sine', gain=0.15){
  if (muted) return;
  ensureAC();
  const g = AC.createGain(); g.gain.value = 0; g.connect(AC.destination);
  g.gain.setTargetAtTime(gain, AC.currentTime, 0.01);
  const now = AC.currentTime;
  freqs.forEach(f=>{
    const o = AC.createOscillator(); o.type = type; o.frequency.value = f;
    o.connect(g); o.start(now); o.stop(now + dur);
  });
  g.gain.setTargetAtTime(0, now + dur*0.8, 0.04);
}
function sfxCorrect(){ beep(880, .09, 'triangle', .18); setTimeout(()=>beep(1175, .09, 'triangle', .16), 110); }
function sfxWrong(){ beep(220, .15, 'sawtooth', .18); setTimeout(()=>beep(180, .12, 'sawtooth', .16), 120); }
function sfxComplete(){ chord([523,659,784], .35, 'sine', .18); setTimeout(()=>chord([659,784,988], .35, 'sine', .16), 380); }

/* =============================
   1) UI: Tabs and badges
   ============================= */
const tabs = $$(".tab");
tabs.forEach(t=>{
  t.addEventListener("click", ()=>{
    tabs.forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    ["learn","practice","dictionary"].forEach(id=>{
      $("#"+id).classList.toggle("hidden", id !== t.dataset.tab);
    });
  });
});
function updateBadges(){ $("#xp").textContent = META.xp; $("#hearts").textContent = META.hearts; $("#streak").textContent = META.streak; }
updateBadges();

/* Controls & keyboard */
const toastEl = $("#toast");
$("#helpBtn").onclick = ()=>toggleHelp();
document.addEventListener("keydown", (e)=>{
  const k = e.key.toLowerCase();
  if (k === "h") toggleHelp();
  if (k === "s") skipChallenge();
});
function toggleHelp(){
  const el = $("#helpModal");
  el.classList.toggle("hidden");
  if (!el.classList.contains("hidden")){
    clearTimeout(el._t); el._t = setTimeout(()=>el.classList.add("hidden"), 5000);
  }
}

/* =============================
   2) Learn (lookup + view)
   ============================= */
$("#lookupBtn").onclick = doLookup;
$("#lookupInput").addEventListener("keydown", e=>{ if (e.key === "Enter") doLookup(); });
$("#viewBtn").onclick = ()=>{ switchTo("dictionary"); renderDictionary(); };

function doLookup(){
  const q = $("#lookupInput").value.trim();
  const out = $("#lookupResult");
  if (!q){ out.style.display="none"; return; }

  const res = lookupBothWays(q);
  if (res.length){
    const html = res.map(r => `
      <div class="card">
        <div><b>${escapeHtml(r.key)}</b> <span class="muted">(${r.cat})</span></div>
        <div class="muted">= ${r.meanings.map(m=>escapeHtml(m)).join(", ")}</div>
      </div>`).join("");
    out.innerHTML = html;
  } else {
    out.innerHTML = `
      <div class="card">
        <div class="big">"${escapeHtml(q)}" not found.</div>
        <div class="flex" style="margin-top:8px">
          <button class="btn primary" id="addFromLookup">Add this word</button>
        </div>
      </div>`;
    $("#addFromLookup").onclick = ()=>openAddModal({ presetKey:q, presetMeanings:"" });
  }
  out.style.display = "block";
}
function lookupBothWays(q){
  const qLC = q.toLowerCase();
  const res = [];
  for (const [k,v] of Object.entries(words_numbers)){
    if (k.toLowerCase()===qLC || v.some(m => m.toLowerCase()===qLC)) res.push({cat:"numbers", key:k, meanings:v});
  }
  for (const [k,v] of Object.entries(words_others)){
    if (k.toLowerCase()===qLC || v.some(m => m.toLowerCase()===qLC)) res.push({cat:"others", key:k, meanings:v});
  }
  if (!res.length){
    for (const [k,v] of Object.entries(words_numbers)){
      if (k.toLowerCase().includes(qLC) || v.some(m => m.toLowerCase().includes(qLC))) res.push({cat:"numbers", key:k, meanings:v});
    }
    for (const [k,v] of Object.entries(words_others)){
      if (k.toLowerCase().includes(qLC) || v.some(m => m.toLowerCase().includes(qLC))) res.push({cat:"others", key:k, meanings:v});
    }
  }
  return res;
}

/* =============================
   3) Practice (Duolingo-style) with sessions & no repeats
   ============================= */
const state = {
  session: null // { cat, dir, mode, remainingKeys:[...] }
};

$("#startPractice").onclick = ()=>startSession();
$("#skipBtn").onclick = ()=>skipChallenge();
$("#clearOrder").onclick = ()=>clearOrder();
$("#submitOrder").onclick = ()=>submitOrder();

function startSession(){
  const cat = $("#catPracticeSel").value;        // all|numbers|others
  const mode = $("#modeSel").value;              // mc|order
  const dir  = $("#directionSel").value;         // en2esan|esan2en

  const pool = entriesForCategory(cat);          // [ [esanKey, [meanings...]], ... ]
  if (pool.length === 0){ toast("No words in this category."); return; }

  state.session = {
    cat, mode, dir,
    remainingKeys: shuffle(pool.map(([k])=>k)) // only keys tracked; remove on correct
  };
  $("#challengeArea").style.display = "block";
  nextChallenge();
}

function entriesForCategory(cat){
  const all = [];
  if (cat === "all" || cat === "numbers"){ for (const [k,v] of Object.entries(words_numbers)) all.push([k,v]); }
  if (cat === "all" || cat === "others"){  for (const [k,v] of Object.entries(words_others))  all.push([k,v]); }
  return all;
}

function nextChallenge(){
  const s = state.session;
  if (!s) return;
  updateProgressNote();
  if (s.remainingKeys.length === 0){
    // Done!
    sfxComplete();
    $("#doneText").textContent = `You've completed all words in "${s.cat}"!`;
    $("#doneModal").classList.remove("hidden");
    return;
  }
  // pick current key from remaining (don’t remove yet; remove only on correct)
  const curKey = s.remainingKeys[0];
  const dict = {...words_numbers, ...words_others};
  const meanings = dict[curKey];

  // make challenge per current session settings
  CURRENT = makeChallengeFrom(curKey, meanings, s.mode, s.dir, s.cat);
  renderChallenge(CURRENT);
}

function updateProgressNote(){
  const s = state.session; if (!s){ $("#progressNote").textContent = ""; return; }
  const total = entriesForCategory(s.cat).length;
  const left = s.remainingKeys.length;
  $("#progressNote").textContent = `Category: ${s.cat} • Remaining: ${left}/${total}`;
}

function makeChallengeFrom(key, meanings, type, direction, catLabel){
  const pool = entriesForCategory(catLabel);
  const meaning = meanings[Math.floor(Math.random()*meanings.length)];
  if (type === "mc"){
    if (direction === "en2esan"){
      const distractors = pickDistractors(pool.map(([k])=>k), key, 3);
      const options = shuffle([key, ...distractors]);
      return { type:"mc", prompt:`Translate: "${meaning}"`, options, answer:key, key };
    } else {
      const allMeanings = pool.flatMap(([k,vals])=>vals);
      const distractors = pickDistractors(allMeanings, meaning, 3);
      const options = shuffle([meaning, ...distractors]);
      return { type:"mc", prompt:`Translate: "${key}"`, options, answer:meaning, key };
    }
  } else {
    const tokens = (direction === "en2esan" ? key : meaning).split(/\s+/).filter(Boolean);
    const bank = shuffle([...tokens, ...pickTokenNoise(2)]);
    return { type:"order", prompt:`Build: "${direction==='en2esan'?meaning:key}"`, tokens, bank, key };
  }
}

function renderChallenge(ch){
  $("#prompt").textContent = ch.prompt;
  $("#mcWrap").classList.add("hidden");
  $("#orderWrap").classList.add("hidden");

  if (ch.type === "mc"){
    const wrap = $("#mcWrap");
    wrap.innerHTML = "";
    ch.options.forEach(opt=>{
      const btn = document.createElement("button");
      btn.className = "answerChoice";
      btn.textContent = opt;
      btn.onclick = ()=>gradeMC(btn, opt===ch.answer, ch.key);
      wrap.appendChild(btn);
    });
    wrap.classList.remove("hidden");
  } else {
    $("#bank").innerHTML = "";
    $("#answerBank").innerHTML = "";
    ch.bank.forEach(tok=>{
      const chip = document.createElement("button");
      chip.className = "chip";
      chip.textContent = tok;
      chip.onclick = ()=>{
        chip.classList.add("used");
        const pick = document.createElement("span");
        pick.className = "chip";
        pick.textContent = tok;
        pick.dataset.tok = tok;
        $("#answerBank").appendChild(pick);
      };
      $("#bank").appendChild(chip);
    });
    $("#orderWrap").classList.remove("hidden");
  }
}

function gradeMC(btn, correct, keyForRemoval){
  for (const b of $$("#mcWrap .answerChoice")) b.disabled = true;
  if (correct){
    btn.classList.add("correct");
    META.xp += 10; META.streak += 1;
    if (META.streak % 5 === 0) META.hearts = Math.min(5, META.hearts + 1);
    saveJson(LS_KEYS.meta, META); updateBadges();
    sfxCorrect(); toast("Correct! +10 XP");
    // remove this key from remaining so it won't repeat
    removeKeyFromSession(keyForRemoval);
    setTimeout(nextChallenge, 500);
  } else {
    btn.classList.add("wrong");
    META.hearts = Math.max(0, META.hearts - 1);
    META.streak = 0;
    saveJson(LS_KEYS.meta, META); updateBadges();
    sfxWrong(); toast("Not quite. -1 ❤");
    setTimeout(nextChallenge, 600);
  }
}

function clearOrder(){
  $("#answerBank").innerHTML = "";
  $$("#bank .chip").forEach(c=>c.classList.remove("used"));
}
function submitOrder(){
  const given = Array.from($("#answerBank").children).map(x=>x.dataset.tok);
  const correct = CURRENT.tokens.join(" ");
  if (given.join(" ") === correct){
    META.xp += 12; META.streak += 1;
    saveJson(LS_KEYS.meta, META); updateBadges();
    sfxCorrect(); toast("¡Perfecto! +12 XP");
    removeKeyFromSession(CURRENT.key);
    setTimeout(nextChallenge, 500);
  } else {
    META.hearts = Math.max(0, META.hearts - 1);
    META.streak = 0;
    saveJson(LS_KEYS.meta, META); updateBadges();
    sfxWrong(); toast(`Answer: ${correct}`);
    setTimeout(nextChallenge, 900);
  }
}

function removeKeyFromSession(key){
  const s = state.session; if (!s) return;
  s.remainingKeys = s.remainingKeys.filter(k => k !== key);
  updateProgressNote();
}

function skipChallenge(){
  if (!state.session) return;
  META.streak = 0; saveJson(LS_KEYS.meta, META); updateBadges();
  toast("Skipped");
  setTimeout(nextChallenge, 120);
}

/* Helpers */
function pickDistractors(list, correct, n){
  const pool = list.filter(x=>x!==correct); const picks = [];
  while (picks.length<n && pool.length){ picks.push(...pool.splice(Math.floor(Math.random()*pool.length),1)); }
  return picks.slice(0,n);
}
function pickTokenNoise(n){
  const noise = ["y","de","la","el","un","una","muy","por","para","con"];
  const out = []; for (let i=0;i<n;i++) out.push(noise[Math.floor(Math.random()*noise.length)]); return out;
}
function shuffle(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

/* =============================
   4) Dictionary (view / add / import / export)
   ============================= */
$("#catFilter").onchange = renderDictionary;
$("#addBtn").onclick = ()=>openAddModal();
$("#exportBtn").onclick = exportJson;
$("#importFile").onchange = importJson;

function renderDictionary(){
  const filter = $("#catFilter").value;
  const list = $("#dictList"); list.innerHTML = "";
  const data = [];
  if (filter === "all" || filter === "numbers"){ for (const [k,v] of Object.entries(words_numbers)) data.push({cat:"numbers", k, v}); }
  if (filter === "all" || filter === "others"){  for (const [k,v] of Object.entries(words_others))  data.push({cat:"others", k, v}); }
  if (!data.length){ list.innerHTML = `<div class="card center muted">No entries yet.</div>`; return; }
  data.sort((a,b)=>a.k.localeCompare(b.k));
  data.forEach(({cat,k,v})=>{
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <div class="flex">
        <div class="big" style="font-weight:800">${escapeHtml(k)}</div>
        <span class="pill">${cat}</span>
        <div class="spacer"></div>
        <button class="btn ghost editBtn">Edit</button>
        <button class="btn ghost delBtn">Delete</button>
      </div>
      <div class="muted" style="margin-top:4px">${v.map(x=>escapeHtml(x)).join(", ")}</div>
    `;
    el.querySelector(".editBtn").onclick = ()=>openAddModal({cat, presetKey:k, presetMeanings:v.join(", ")});
    el.querySelector(".delBtn").onclick = ()=>{
      if (!confirm(`Delete "${k}"?`)) return;
      if (cat==="numbers") delete words_numbers[k]; else delete words_others[k];
      persistDicts(); renderDictionary(); toast("Deleted");
    };
    list.appendChild(el);
  });
}

function openAddModal(opts={}){
  const {cat="others", presetKey="", presetMeanings=""} = opts;
  const modal = document.createElement("div");
  modal.className = "toast";
  modal.style.maxWidth = "720px"; modal.style.width = "calc(100% - 32px)";
  modal.innerHTML = `
    <div class="big" style="font-weight:900; margin-bottom:8px">Add / Edit Word</div>
    <div class="grid" style="grid-template-columns:1fr 1fr; gap:8px">
      <label>Category
        <select id="mCat">
          <option value="numbers">Numbers</option>
          <option value="others">Others</option>
        </select>
      </label>
      <label>Word (Esan key)
        <input id="mKey" type="text" placeholder="e.g., Uwa" />
      </label>
      <label style="grid-column:1 / -1">Meanings (English, comma separated)
        <input id="mVals" type="text" placeholder="e.g., House, Building, Home" />
      </label>
    </div>
    <div class="flex" style="margin-top:8px">
      <button id="mSave" class="btn primary">Save</button>
      <button id="mCancel" class="btn">Cancel</button>
    </div>
  `;
  document.body.appendChild(modal);
  $("#mCat", modal).value = cat;
  $("#mKey", modal).value = presetKey;
  $("#mVals", modal).value = presetMeanings;
  $("#mCancel", modal).onclick = ()=>modal.remove();
  $("#mSave", modal).onclick = ()=>{
    const c = $("#mCat", modal).value;
    const k = $("#mKey", modal).value.trim();
    const vals = $("#mVals", modal).value.split(",").map(s=>s.trim()).filter(Boolean);
    if (!k || !vals.length){ alert("Please enter a word and at least one meaning."); return; }
    if (c==="numbers") words_numbers[k] = vals; else words_others[k] = vals;
    persistDicts(); modal.remove(); renderDictionary(); toast("Saved");
  };
}
function exportJson(){
  const blob = new Blob([JSON.stringify({numbers:words_numbers, others:words_others}, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "lingo-dictionary.json";
  a.click();
}
function importJson(e){
  const f = e.target.files[0]; if (!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      if (obj.numbers && obj.others){
        words_numbers = obj.numbers;
        words_others  = obj.others;
        persistDicts(); renderDictionary(); toast("Imported");
      } else { alert("Invalid JSON structure."); }
    } catch(err){ alert("Failed to parse JSON."); }
  };
  reader.readAsText(f);
}

/* =============================
   5) Utilities & Done flow
   ============================= */
function switchTo(id){
  tabs.forEach(x => x.classList.toggle("active", x.dataset.tab===id));
  ["learn","practice","dictionary"].forEach(sec => $("#"+sec).classList.toggle("hidden", sec!==id));
}
function persistDicts(){ saveJson(LS_KEYS.numbers, words_numbers); saveJson(LS_KEYS.others, words_others); }
function toast(msg){ toastEl.textContent = msg; toastEl.classList.remove("hidden"); clearTimeout(toastEl._t); toastEl._t = setTimeout(()=>toastEl.classList.add("hidden"), 1400); }
function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }

/* Done modal actions */
$("#chooseAnother").onclick = ()=>{
  $("#doneModal").classList.add("hidden");
  switchTo("practice");
  // user can change category in dropdown, then press Start
};
$("#repeatSession").onclick = ()=>{
  if (!state.session){ $("#doneModal").classList.add("hidden"); return; }
  // reset remaining keys from current category
  const s = state.session;
  s.remainingKeys = shuffle(entriesForCategory(s.cat).map(([k])=>k));
  $("#doneModal").classList.add("hidden");
  nextChallenge();
};
$("#closeDone").onclick = ()=>{ $("#doneModal").classList.add("hidden"); };

/* Initial renders */
renderDictionary();
</script>
</body>
</html>
