<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lingo Dictionary — Duolingo-style (No-repeat distractors)</title>
<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --ink:#e2e8f0; --muted:#94a3b8;
    --card:#0b1325; --line:#1f2a44; --accent1:#22d3ee; --accent2:#34d399;
    --warn:#ef4444; --ok:#06d6a0; --gold:#facc15;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  button,input,select,label{pointer-events:auto}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .hero{background: linear-gradient(180deg,#132038 0%, #0f172a 100%);border:1px solid var(--line); border-radius:16px; padding:16px 16px 0; margin-bottom:12px;}
  .title{ margin:0; font-size:22px; font-weight:900; background:linear-gradient(90deg,var(--accent2),var(--accent1)); -webkit-background-clip:text; background-clip:text; color:transparent;}
  .tabs{ display:flex; gap:8px; margin:12px 0 0 }
  .tab{ flex:1; text-align:center; padding:10px; cursor:pointer; border:1px solid var(--line); color:var(--ink); background:var(--panel); border-radius:12px 12px 0 0; font-weight:700 }
  .tab.active{ background:linear-gradient(180deg,#152240,#0f172a); border-bottom-color:transparent }
  .panel{ border:1px solid var(--line); border-top:none; background:var(--panel); padding:16px; border-radius:0 12px 12px 12px;}
  .row{ display:flex; gap:10px; flex-wrap:wrap }
  input[type="text"], select{ background:var(--card); border:1px solid var(--line); color:var(--ink); border-radius:10px; padding:10px 12px; outline:none; width:100%;}
  .btn{ padding:10px 14px; border:none; border-radius:10px; background:#1e293b; color:#0f172a; color:var(--ink); cursor:pointer }
  .btn.primary{ background:linear-gradient(90deg,var(--accent2),var(--accent1)); color:#0b1020; font-weight:800 }
  .btn.ghost{ background:transparent; border:1px solid var(--line) }
  .pill{ padding:6px 10px; border:1px solid var(--line); background:var(--card); border-radius:999px; font-size:13px }
  .grid{ display:grid; gap:10px }
  .cards{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px }
  .muted{ color:var(--muted) }
  .badge{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px }
  .badge.ok{ background:rgba(6,214,160,.12); color:var(--ok) }
  .badge.warn{ background:rgba(239,68,68,.12); color:var(--warn) }
  .badge.gold{ background:rgba(250,204,21,.12); color:var(--gold) }
  .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; background:#111827; color:#e5e7eb; padding:10px 14px; border-radius:10px; border:1px solid #1f2937; box-shadow:0 10px 30px rgba(0,0,0,.35); z-index:20 }
  .flex{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  .spacer{ flex:1 }
  .hidden{ display:none !important }
  /* overlays can't intercept when hidden */
  .toast.hidden, .modal.hidden{ pointer-events:none !important; }
  .center{ text-align:center }
  .big{ font-size:18px }
  @media (max-width:600px){ .title{font-size:20px} }
  .answerChoice{ width:100%; text-align:left; background:#0c1730; border:1px solid var(--line); color:var(--ink); padding:12px; border-radius:12px; cursor:pointer; }
  .answerChoice.correct{ outline:2px solid var(--ok) }
  .answerChoice.wrong{ outline:2px solid var(--warn) }
  .bank{ display:flex; gap:8px; flex-wrap:wrap; padding:8px; background:#0c1730; border:1px dashed var(--line); border-radius:12px }
  .chip{ padding:8px 10px; background:#0f1d36; border:1px solid var(--line); border-radius:999px; cursor:pointer }
  .chip.used{ opacity:.5; pointer-events:none }
  .kbd{ background:#111; border:1px solid #333; padding:2px 6px; border-radius:6px; color:#fff }
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:50 }
  .panel2{ background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:16px; width:min(560px, 94%); box-shadow:0 20px 60px rgba(0,0,0,.35) }
  .rowC{ display:flex; align-items:center; gap:10px; justify-content:center; flex-wrap:wrap }
  .mute{ margin-left:6px;}
  .reviewRow{ display:flex; align-items:center; gap:10px; justify-content:space-between; padding:10px; border:1px dashed var(--line); border-radius:12px; background:rgba(34,211,238,.05) }
</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <div class="flex">
      <h1 class="title">Lingo Dictionary — Duolingo-style</h1>
      <span class="badge gold" title="Streak">🔥 <span id="streak">0</span></span>
      <span class="badge ok" title="XP">⭐ <span id="xp">0</span></span>
      <span class="badge warn" title="Hearts">❤ <span id="hearts">5</span></span>
      <div class="spacer"></div>
      <label class="pill">🔊 Sound <input id="muteToggle" class="mute" type="checkbox" /></label>
      <span class="pill" id="heartControls">
        ❤ Hearts:
        <button class="btn ghost" id="btnHPlus1" type="button">+1</button>
        <button class="btn ghost" id="btnHPlus5" type="button">+5</button>
        <button class="btn ghost" id="btnHRefill" type="button">Refill</button>
        <label style="margin-left:6px">Unlimited <input id="unlimitedToggle" type="checkbox" /></label>
      </span>
      <button id="helpBtn" class="btn ghost" type="button">Controls</button>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="learn" type="button">Learn</button>
      <button class="tab" data-tab="practice" type="button">Practice</button>
      <button class="tab" data-tab="dictionary" type="button">Dictionary</button>
    </div>
  </div>

  <!-- Learn -->
  <section id="learn" class="panel">
    <div class="grid" style="grid-template-columns:1.6fr .8fr .8fr">
      <div class="row">
        <input id="lookupInput" type="text" placeholder="Type a word (key or meaning) and press Enter…" />
      </div>
      <button id="lookupBtn" class="btn primary" type="button">Look up</button>
      <button id="viewBtn" class="btn" type="button">View all</button>
    </div>
    <div id="lookupResult" class="card" style="margin-top:12px; display:none"></div>
  </section>

  <!-- Practice -->
  <section id="practice" class="panel hidden">
    <div class="flex">
      <div class="pill">Category:
        <select id="catPracticeSel"></select>
      </div>
      <div class="pill">Mode:
        <select id="modeSel">
          <option value="mc">Multiple Choice</option>
          <option value="order">Word Bank (order)</option>
        </select>
      </div>
      <div class="pill">Direction:
        <select id="directionSel">
          <option value="en2key">English → Word</option>
          <option value="key2en">Word → English</option>
        </select>
      </div>
      <div class="spacer"></div>
      <button id="startPractice" class="btn primary" type="button">Start</button>
      <button id="skipBtn" class="btn" type="button">Skip</button>
    </div>

    <div id="progressNote" class="muted" style="margin-top:8px"></div>

    <div id="challengeArea" class="card" style="margin-top:12px; display:none">
      <div id="prompt" class="big" style="margin-bottom:10px;"></div>
      <div id="mcWrap" class="grid hidden" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))"></div>
      <div id="orderWrap" class="hidden">
        <div class="bank" id="bank"></div>
        <div style="margin-top:8px" class="bank" id="answerBank"></div>
        <div class="flex" style="margin-top:8px">
          <button id="clearOrder" class="btn" type="button">Clear</button>
          <button id="submitOrder" class="btn primary" type="button">Submit</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Dictionary -->
  <section id="dictionary" class="panel hidden">
    <div class="flex">
      <div class="pill">Filter:
        <select id="catFilter"></select>
      </div>
      <div class="spacer"></div>
      <button id="exportBtn" class="btn" type="button">Export JSON</button>
      <label class="btn ghost" for="importFile">Import JSON</label>
      <input id="importFile" type="file" accept=".json" style="display:none" />
      <button id="addBtn" class="btn primary" type="button">Add Word</button>
    </div>

    <!-- Earn hearts by review -->
    <div id="reviewCard" class="card" style="margin-top:12px; display:none">
      <div class="big" style="font-weight:800;margin-bottom:6px">Review to earn hearts</div>
      <div class="muted" style="margin-bottom:8px">Practice missed words. Each correct review restores <b>+1 ❤</b> (up to 5).</div>
      <div id="reviewList" class="grid" style="grid-template-columns:1fr"></div>
    </div>

    <div id="dictList" class="cards" style="margin-top:12px"></div>
  </section>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden" aria-live="polite"></div>

<!-- Help Modal -->
<div id="helpModal" class="toast hidden" style="top:16px; bottom:auto; max-width:720px; width:calc(100% - 32px)">
  <div class="big" style="margin-bottom:6px; font-weight:900">Controls</div>
  <div class="muted">
    • Practice: choose a category (or All) • Unlimited mode lets you keep playing even at 0 hearts • Use Dictionary to add/edit words or review misses for hearts
  </div>
</div>

<!-- Out of Hearts Modal -->
<div id="outModal" class="modal hidden" aria-hidden="true">
  <div class="panel2 center">
    <div class="big" style="font-weight:900">Out of hearts</div>
    <div class="muted" style="margin:8px 0 12px">Turn on <b>Unlimited</b> or review missed words in the Dictionary to earn hearts and continue.</div>
    <div class="rowC">
      <button id="goReview" class="btn primary" type="button">Go to Dictionary</button>
      <button id="dismissOut" class="btn" type="button">Close</button>
    </div>
  </div>
</div>

<!-- Congrats Modal -->
<div id="doneModal" class="modal hidden" aria-hidden="true">
  <div class="panel2 center">
    <div class="big" style="font-weight:900">🎉 Congrats!</div>
    <div class="muted" id="doneText" style="margin:8px 0 12px">You completed this category.</div>
    <div class="rowC">
      <button id="chooseAnother" class="btn" type="button">Choose Another Category</button>
      <button id="repeatSession" class="btn ghost" type="button">Repeat This Category</button>
      <button id="closeDone" class="btn primary" type="button">Close</button>
    </div>
  </div>
</div>

<!-- Review Modal -->
<div id="reviewModal" class="modal hidden" aria-hidden="true">
  <div class="panel2">
    <div class="big" id="reviewPrompt" style="margin-bottom:10px;font-weight:800">Review</div>
    <div id="reviewChoices" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))"></div>
    <div class="rowC" style="margin-top:10px">
      <button id="closeReview" class="btn" type="button">Close</button>
    </div>
  </div>
</div>

<script>
/* Wait for DOM */
window.addEventListener('DOMContentLoaded', () => {
/* ---------- Helpers ---------- */
const $  = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const toastEl = $("#toast");
const LS = {
  words: "lingo_words_v2",
  meta:  "lingo_meta",
  mute:  "lingo_mute",
  missed:"lingo_missed_v2",
  unlimited:"lingo_unlimited"
};
const load = (k,d=null)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d; }catch{ return d; } };
const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
function toast(m){ toastEl.textContent=m; toastEl.classList.remove("hidden"); clearTimeout(toastEl._t); toastEl._t=setTimeout(()=>toastEl.classList.add("hidden"),1400); }
function shuffle(a){ const x=a.slice(); for(let i=x.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[x[i],x[j]]=[x[j],x[i]]} return x; }
function pickDistractors(list, correct, n){ const pool=list.filter(x=>x!==correct), out=[]; while(out.length<n&&pool.length){ out.push(...pool.splice(Math.random()*pool.length|0,1)); } return out.slice(0,n); }
function escapeHtml(s){ return s.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

/* ---------- Sounds ---------- */
let AC, muted = localStorage.getItem(LS.mute)==="1";
const muteToggle = $("#muteToggle"); muteToggle.checked=muted;
muteToggle.onchange=()=>{ muted=muteToggle.checked; localStorage.setItem(LS.mute, muted?"1":"0"); };
function ensureAC(){ if(!AC) AC = new (window.AudioContext||window.webkitAudioContext)(); }
function beep(f=880,d=.12,t='sine',g=.2){ if(muted) return; ensureAC(); const o=AC.createOscillator(),k=AC.createGain(); o.type=t;o.frequency.value=f;k.gain.value=0;o.connect(k).connect(AC.destination);o.start();k.gain.setTargetAtTime(g,AC.currentTime,.01);k.gain.setTargetAtTime(0,AC.currentTime+d*.8,.03);o.stop(AC.currentTime+d); }
function chord(F=[523,659,784],d=.35,t='sine',g=.15){ if(muted) return; ensureAC(); const k=AC.createGain();k.gain.value=0;k.connect(AC.destination);k.gain.setTargetAtTime(g,AC.currentTime,.01);const now=AC.currentTime;F.forEach(f=>{const o=AC.createOscillator();o.type=t;o.frequency.value=f;o.connect(k);o.start(now);o.stop(now+d)});k.gain.setTargetAtTime(0,now+d*.8,.04); }
const sfxCorrect=()=>{beep(880,.09,'triangle',.18);setTimeout(()=>beep(1175,.09,'triangle',.16),110)};
const sfxWrong=()=>{beep(220,.15,'sawtooth',.18);setTimeout(()=>beep(180,.12,'sawtooth',.16),120)};
const sfxComplete=()=>{chord([523,659,784],.35);setTimeout(()=>chord([659,784,988],.35),380)};

/* ---------- Categories + seed (18 total) ---------- */
const CATS = [
  "numbers","others","greetings","colors","animals","food","verbs_basic","verbs_travel",
  "phrases","questions","time","days_months","family","directions","clothing",
  "weather","body","school"
];
const SEED = {
  numbers: { "3n1 triplets": ["Akhinsin N"], "one": ["1"], "two": ["2"], "three": ["3"] },
  others:  { "Uwa": ["House","Building","Home"], "Elo": ["Eye","Sight"], "Aga": ["Chair","Seat"], "Obo": ["Hand","Palm"] },
  greetings: { "Hola": ["Hello"], "Buenos días": ["Good morning"], "Buenas noches": ["Good night"] },
  colors: { "Rojo": ["Red"], "Azul": ["Blue"], "Verde": ["Green"] },
  animals: { "Perro": ["Dog"], "Gato": ["Cat"], "Pájaro": ["Bird"] },
  food: { "Pan": ["Bread"], "Agua": ["Water"], "Manzana": ["Apple"] },
  verbs_basic: { "Ser": ["To be"], "Tener": ["To have"], "Querer": ["To want"] },
  verbs_travel: { "Viajar": ["To travel"], "Llegar": ["To arrive"], "Salir": ["To leave"] },
  phrases: { "¿Cómo estás?": ["How are you?"], "Lo siento": ["I'm sorry"], "Por favor": ["Please"] },
  questions: { "¿Qué?": ["What?"], "¿Dónde?": ["Where?"], "¿Cuándo?": ["When?"] },
  time: { "Hoy": ["Today"], "Mañana": ["Tomorrow"], "Ayer": ["Yesterday"] },
  days_months: { "Lunes": ["Monday"], "Martes": ["Tuesday"], "Enero": ["January"] },
  family: { "Madre": ["Mother"], "Padre": ["Father"], "Hermano": ["Brother"] },
  directions: { "Izquierda": ["Left"], "Derecha": ["Right"], "Recto": ["Straight"] },
  clothing: { "Camisa": ["Shirt"], "Pantalones": ["Pants"], "Zapatos": ["Shoes"] },
  weather: { "Lluvia": ["Rain"], "Nieve": ["Snow"], "Viento": ["Wind"] },
  body: { "Cabeza": ["Head"], "Mano": ["Hand"], "Pie": ["Foot"] },
  school: { "Escuela": ["School"], "Libro": ["Book"], "Maestro": ["Teacher"] }
};

/* ---------- Storage + migration from very old keys ---------- */
(function migrateOld(){
  const oldNums = load("lingo_numbers");
  const oldOth  = load("lingo_others");
  if (oldNums || oldOth){
    const merged = JSON.parse(JSON.stringify(SEED));
    if (oldNums) merged.numbers = oldNums;
    if (oldOth)  merged.others  = oldOth;
    save(LS.words, merged);
    localStorage.removeItem("lingo_numbers");
    localStorage.removeItem("lingo_others");
  }
})();
let WORDS = load(LS.words, SEED);
CATS.forEach(c=>{ if(!WORDS[c]) WORDS[c]={}; });
save(LS.words, WORDS);

/* meta, missed, unlimited */
let META = load(LS.meta, { xp:0, hearts:5, streak:0 });
let MISSED = new Set(load(LS.missed, []));            // tokens "cat::key"
let UNLIMITED = localStorage.getItem(LS.unlimited)==="1";

/* ---------- Header + tabs ---------- */
function updateBadges(){ $("#xp").textContent=META.xp; $("#hearts").textContent=META.hearts; $("#streak").textContent=META.streak; }
updateBadges();

const tabs = $$(".tab");
tabs.forEach(t=>t.addEventListener("click", ()=>{
  tabs.forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  ["learn","practice","dictionary"].forEach(id=>$("#"+id).classList.toggle("hidden", id!==t.dataset.tab));
  if (t.dataset.tab==="dictionary") renderDictionary();
}));

$("#helpBtn").onclick=()=>{ const el=$("#helpModal"); el.classList.toggle("hidden"); if(!el.classList.contains("hidden")){ clearTimeout(el._t); el._t=setTimeout(()=>el.classList.add("hidden"),5000); } };

/* HEART OVERRIDE CONTROLS */
const unlimitedToggle = $("#unlimitedToggle");
unlimitedToggle.checked = UNLIMITED;
unlimitedToggle.onchange = ()=>{ UNLIMITED = unlimitedToggle.checked; localStorage.setItem(LS.unlimited, UNLIMITED?"1":"0"); toast(UNLIMITED?"Unlimited ON":"Unlimited OFF"); };

$("#btnHPlus1").onclick = ()=>{ META.hearts = Math.min(99, META.hearts+1); save(LS.meta,META); updateBadges(); sfxCorrect(); };
$("#btnHPlus5").onclick = ()=>{ META.hearts = Math.min(99, META.hearts+5); save(LS.meta,META); updateBadges(); sfxCorrect(); };
$("#btnHRefill").onclick = ()=>{ META.hearts = Math.max(META.hearts,5); save(LS.meta,META); updateBadges(); sfxCorrect(); };

/* ---------- Fill dynamic category dropdowns ---------- */
function fillCategorySelects(){
  const opts = ['<option value="all">All</option>'].concat(CATS.map(c=>`<option value="${c}">${c}</option>`)).join("");
  $("#catPracticeSel").innerHTML = opts;
  $("#catFilter").innerHTML = opts;
}
fillCategorySelects();

/* ---------- Learn ---------- */
$("#lookupBtn").onclick = doLookup;
$("#lookupInput").addEventListener("keydown", e=>{ if(e.key==="Enter") doLookup(); });
$("#viewBtn").onclick = ()=>{ switchTo("dictionary"); renderDictionary(); };

function doLookup(){
  const q=$("#lookupInput").value.trim(); const out=$("#lookupResult");
  if(!q){ out.style.display="none"; return; }
  const res = lookupAny(q);
  if(res.length){
    out.innerHTML = res.map(r=>`
      <div class="card">
        <div><b>${escapeHtml(r.key)}</b> <span class="muted">(${r.cat})</span></div>
        <div class="muted">= ${r.vals.map(m=>escapeHtml(m)).join(", ")}</div>
      </div>`).join("");
  }else{
    out.innerHTML = `
      <div class="card">
        <div class="big">"${escapeHtml(q)}" not found.</div>
        <div class="flex" style="margin-top:8px">
          <button id="addFromLookup" class="btn primary" type="button">Add this word</button>
        </div>
      </div>`;
    $("#addFromLookup").onclick = ()=>openAddModal({ presetKey:q, presetMeanings:"" });
  }
  out.style.display="block";
}
function lookupAny(q){
  const qLC=q.toLowerCase(); const out=[];
  for(const cat of CATS){ for(const [k,v] of Object.entries(WORDS[cat]||{})){
    if (k.toLowerCase()===qLC || v.some(m=>m.toLowerCase()===qLC) ||
        k.toLowerCase().includes(qLC) || v.some(m=>m.toLowerCase().includes(qLC))){
      out.push({cat, key:k, vals:v});
    }
  }}
  return out;
}

/* ---------- Practice (sessions, NO-REPEAT DISTRACTORS, hearts) ---------- */
const state = { session:null }; // { cat, dir, mode, remaining:[{cat,key}] }
$("#startPractice").onclick = ()=>startSession();
$("#skipBtn").onclick = ()=>skipChallenge();
$("#clearOrder").onclick = ()=>{ $("#answerBank").innerHTML=""; $$("#bank .chip").forEach(c=>c.classList.remove("used")); };
$("#submitOrder").onclick = ()=>submitOrder();
$("#goReview").onclick = ()=>{ $("#outModal").classList.add("hidden"); switchTo("dictionary"); renderDictionary(); };
$("#dismissOut").onclick = ()=>$("#outModal").classList.add("hidden");
document.addEventListener("keydown", e=>{ if(e.key.toLowerCase()==="s") skipChallenge(); });

function startSession(){
  if (!UNLIMITED && META.hearts<=0){ $("#outModal").classList.remove("hidden"); return; }
  const cat=$("#catPracticeSel").value;
  const mode=$("#modeSel").value;
  const dir=$("#directionSel").value;
  const pool = entriesFor(cat);
  if(!pool.length){ toast("No words in this category."); return; }
  state.session={ cat, mode, dir, remaining: shuffle(pool.map(([c,k])=>({cat:c,key:k}))) };
  $("#challengeArea").style.display="block";
  nextChallenge();
}
function entriesFor(cat){
  const arr=[];
  const cats = cat==="all" ? CATS : [cat];
  cats.forEach(c=>{
    for(const k of Object.keys(WORDS[c]||{})) arr.push([c,k]);
  });
  return arr;
}

/* ✅ NEW: use only remaining session entries for future distractors */
function remainingEntriesFor(catLabel){
  if (state.session){
    const wantAll = state.session.cat === "all";
    return state.session.remaining
      .filter(({cat}) => wantAll || cat === state.session.cat)
      .map(({cat, key}) => [cat, key]);
  }
  return entriesFor(catLabel);
}

/* 🔁 UPDATED: build MC from remaining-only pool so solved words never reappear as options */
function makeChallengeFrom(cur, meanings, type, direction, catLabel){
  const pool = remainingEntriesFor(catLabel);  // only remaining
  const meaning = meanings[Math.random()*meanings.length|0];

  if(type==="mc"){
    if(direction==="en2key"){
      const distractors = pickDistractors(pool.map(([,k])=>k), cur.key, 3);
      return { type:"mc", prompt:`Translate: "${meaning}"`, options:shuffle([cur.key,...distractors]), answer:cur.key, cur };
    } else {
      const allMeanings = pool.flatMap(([c,k])=>WORDS[c][k]);
      const distractors = pickDistractors(allMeanings, meaning, 3);
      return { type:"mc", prompt:`Translate: "${cur.key}"`, options:shuffle([meaning,...distractors]), answer:meaning, cur };
    }
  }else{
    // Word-bank: pieces are only from the current item (plus small neutral noise)
    const tokens = (direction==="en2key"?cur.key:meaning).split(/\s+/).filter(Boolean);
    const noise = ["y","de","la","el","un","una","muy","por","para","con"];
    const bank = shuffle([...tokens, ...shuffle(noise).slice(0, Math.min(2, noise.length))]);
    return { type:"order", prompt:`Build: "${direction==='en2key'?meaning:cur.key}"`, tokens, bank, cur };
  }
}

function renderChallenge(ch){
  $("#prompt").textContent = ch.prompt;
  $("#mcWrap").classList.add("hidden"); $("#orderWrap").classList.add("hidden");
  if(ch.type==="mc"){
    const wrap=$("#mcWrap"); wrap.innerHTML="";
    ch.options.forEach(opt=>{
      const b=document.createElement("button"); b.className="answerChoice"; b.type="button"; b.textContent=opt;
      b.onclick=()=>gradeMC(b, opt===ch.answer, ch.cur);
      wrap.appendChild(b);
    });
    wrap.classList.remove("hidden");
  }else{
    $("#bank").innerHTML=""; $("#answerBank").innerHTML="";
    ch.bank.forEach(tok=>{
      const c=document.createElement("button"); c.className="chip"; c.type="button"; c.textContent=tok;
      c.onclick=()=>{ c.classList.add("used"); const pick=document.createElement("span"); pick.className="chip"; pick.textContent=tok; pick.dataset.tok=tok; $("#answerBank").appendChild(pick); };
      $("#bank").appendChild(c);
    });
    $("#orderWrap").classList.remove("hidden");
  }
}
function gradeMC(btn, correct, cur){
  for(const b of $$("#mcWrap .answerChoice")) b.disabled=true;
  if(correct){ onCorrect(cur); } else { onWrong(cur); }
}
function submitOrder(){
  const given=Array.from($("#answerBank").children).map(x=>x.dataset.tok).join(" ");
  const correct=CURRENT.tokens.join(" ");
  if(given===correct){ onCorrect(CURRENT.cur,true); } else { onWrong(CURRENT.cur,true, correct); }
}
function onCorrect(cur, order=false){
  META.xp += order?12:10; META.streak += 1; if(META.streak%5===0 && !UNLIMITED) META.hearts = Math.min(99, META.hearts+1);
  save(LS.meta,META); updateBadges(); sfxCorrect(); toast(order?"¡Perfecto! +12 XP":"+10 XP");
  // remove from session & from MISSED
  state.session.remaining = state.session.remaining.filter(x=>!(x.cat===cur.cat && x.key===cur.key));
  MISSED.delete(`${cur.cat}::${cur.key}`); save(LS.missed, Array.from(MISSED));
  setTimeout(nextChallenge, 500);
}
function onWrong(cur, order=false, corr=null){
  if(!UNLIMITED){ META.hearts = Math.max(0, META.hearts-1); }
  META.streak=0; save(LS.meta,META); updateBadges(); sfxWrong();
  MISSED.add(`${cur.cat}::${cur.key}`); save(LS.missed, Array.from(MISSED));
  toast(order?`Answer: ${corr}`:"Not quite.");
  setTimeout(()=>{ if(META.hearts<=0 && !UNLIMITED) $("#outModal").classList.remove("hidden"); nextChallenge(); }, order?900:600);
}
function skipChallenge(){ if(!state.session) return; META.streak=0; save(LS.meta,META); updateBadges(); toast("Skipped"); setTimeout(nextChallenge,120); }

/* ---------- Dictionary (view/add/edit/delete) + Review for hearts ---------- */
$("#catFilter").onchange = renderDictionary;
$("#addBtn").onclick = ()=>openAddModal();
$("#exportBtn").onclick = exportJson;
$("#importFile").onchange = importJson;
$("#closeReview").onclick = ()=>$("#reviewModal").classList.add("hidden");

function renderDictionary(){
  renderReviewCard();

  const cat=$("#catFilter").value; const list=$("#dictList"); list.innerHTML="";
  let items=[];
  const cats = cat==="all"?CATS:[cat];
  cats.forEach(c=>{
    for(const [k,v] of Object.entries(WORDS[c]||{})) items.push({cat:c, k, v});
  });
  if(!items.length){ list.innerHTML=`<div class="card center muted">No entries yet.</div>`; return; }
  items.sort((a,b)=>a.k.localeCompare(b.k));
  items.forEach(({cat,k,v})=>{
    const el=document.createElement("div"); el.className="card";
    el.innerHTML=`
      <div class="flex">
        <div class="big" style="font-weight:800">${escapeHtml(k)}</div>
        <span class="pill">${cat}</span>
        <div class="spacer"></div>
        <button class="btn ghost editBtn" type="button">Edit</button>
        <button class="btn ghost delBtn" type="button">Delete</button>
      </div>
      <div class="muted" style="margin-top:4px">${v.map(x=>escapeHtml(x)).join(", ")}</div>
    `;
    el.querySelector(".editBtn").onclick=()=>openAddModal({cat, presetKey:k, presetMeanings:v.join(", ")});
    el.querySelector(".delBtn").onclick=()=>{
      if(!confirm(`Delete "${k}" in ${cat}?`)) return;
      delete WORDS[cat][k]; save(LS.words,WORDS); renderDictionary(); toast("Deleted");
    };
    list.appendChild(el);
  });
}
function renderReviewCard(){
  const all=WORDS; const missedArr=Array.from(MISSED).map(s=>s.split("::")).filter(([c,k])=>all[c]&&all[c][k]);
  const card=$("#reviewCard"), list=$("#reviewList");
  if(!missedArr.length){ card.style.display="none"; return; }
  card.style.display="block"; list.innerHTML="";
  missedArr.forEach(([cat,key])=>{
    const row=document.createElement("div"); row.className="reviewRow";
    const meanings=all[cat][key];
    row.innerHTML=`
      <div><b>${escapeHtml(key)}</b> <span class="muted">(${cat})</span> <span class="muted">= ${meanings.map(escapeHtml).join(", ")}</span></div>
      <div class="rowC">
        <button class="btn primary" type="button">Practice</button>
        <button class="btn ghost" type="button">Remove</button>
      </div>`;
    const [practiceBtn, removeBtn]=row.querySelectorAll("button");
    practiceBtn.onclick=()=>openReview(cat,key,meanings);
    removeBtn.onclick=()=>{ MISSED.delete(`${cat}::${key}`); save(LS.missed,Array.from(MISSED)); renderReviewCard(); };
    list.appendChild(row);
  });
}
function openReview(cat,key,meanings){
  $("#reviewPrompt").textContent=`Review: Translate "${key}" (${cat})`;
  const allMeanings=Object.values(WORDS).flatMap(catObj=>Object.values(catObj)).flat();
  const target=meanings[Math.random()*meanings.length|0];
  const distractors=pickDistractors(allMeanings,target,3);
  const options=shuffle([target,...distractors]);
  const wrap=$("#reviewChoices"); wrap.innerHTML="";
  options.forEach(opt=>{
    const b=document.createElement("button"); b.className="answerChoice"; b.type="button"; b.textContent=opt;
    b.onclick=()=>{
      if(opt===target){
        META.hearts = Math.min(99, META.hearts+1); save(LS.meta,META); updateBadges();
        MISSED.delete(`${cat}::${key}`); save(LS.missed,Array.from(MISSED));
        sfxCorrect(); toast("+1 ❤ from review!"); $("#reviewModal").classList.add("hidden"); renderReviewCard();
      }else{ sfxWrong(); toast("Try again"); }
    };
    wrap.appendChild(b);
  });
  $("#reviewModal").classList.remove("hidden");
}

function openAddModal(opts={}){
  const {cat=CATS[0], presetKey="", presetMeanings=""}=opts;
  const modal=document.createElement("div"); modal.className="toast"; modal.style.maxWidth="720px"; modal.style.width="calc(100% - 32px)";
  modal.innerHTML=`
    <div class="big" style="font-weight:900;margin-bottom:8px">Add / Edit Word</div>
    <div class="grid" style="grid-template-columns:1fr 1fr; gap:8px">
      <label>Category
        <select id="mCat">${CATS.map(c=>`<option value="${c}">${c}</option>`).join("")}</select>
      </label>
      <label>Word (key)
        <input id="mKey" type="text" placeholder="e.g., Hola" />
      </label>
      <label style="grid-column:1 / -1">Meanings (comma separated)
        <input id="mVals" type="text" placeholder="e.g., Hello, Hi" />
      </label>
    </div>
    <div class="flex" style="margin-top:8px">
      <button id="mSave" class="btn primary" type="button">Save</button>
      <button id="mCancel" class="btn" type="button">Cancel</button>
    </div>`;
  document.body.appendChild(modal);
  $("#mCat",modal).value=cat; $("#mKey",modal).value=presetKey; $("#mVals",modal).value=presetMeanings;
  $("#mCancel",modal).onclick=()=>modal.remove();
  $("#mSave",modal).onclick=()=>{
    const c=$("#mCat",modal).value; const k=$("#mKey",modal).value.trim();
    const vals=$("#mVals",modal).value.split(",").map(s=>s.trim()).filter(Boolean);
    if(!k||!vals.length){ alert("Please enter a word and at least one meaning."); return; }
    WORDS[c][k]=vals; save(LS.words,WORDS); modal.remove(); renderDictionary(); toast("Saved");
  };
}
function exportJson(){ const blob=new Blob([JSON.stringify(WORDS,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="lingo-words.json"; a.click(); }
function importJson(e){
  const f=e.target.files[0]; if(!f) return; const r=new FileReader();
  r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(obj && typeof obj==="object"){ WORDS=obj; CATS.forEach(c=>{ if(!WORDS[c]) WORDS[c]={}; }); save(LS.words,WORDS); renderDictionary(); toast("Imported"); } else alert("Invalid JSON."); }catch{ alert("Failed to parse JSON."); } };
  r.readAsText(f);
}

/* ---------- Done modal actions ---------- */
$("#chooseAnother").onclick=()=>{ $("#doneModal").classList.add("hidden"); switchTo("practice"); };
$("#repeatSession").onclick=()=>{ if(!state.session){ $("#doneModal").classList.add("hidden"); return; } const s=state.session; s.remaining=shuffle(entriesFor(s.cat).map(([c,k])=>({cat:c,key:k}))); $("#doneModal").classList.add("hidden"); nextChallenge(); };
$("#closeDone").onclick=()=>$("#doneModal").classList.add("hidden");

/* ---------- Switch helper ---------- */
function switchTo(id){
  tabs.forEach(x=>x.classList.toggle("active", x.dataset.tab===id));
  ["learn","practice","dictionary"].forEach(sec=>$("#"+sec).classList.toggle("hidden", sec!==id));
}

/* ---------- Initial UI ---------- */
function renderDictionary(){ /* intentionally declared above; first call here */ }
renderDictionary = renderDictionary; // keep reference for tabs
function updateUI(){ updateBadges(); renderDictionary(); }
updateUI();

}); // DOMContentLoaded
</script>
</body>
</html>
